var PagoServicio=function(){function n(){this.ordenDeVentaServicio=new OrdenDeVentaServicio}return n.prototype.formarPagoUnico=function(n,t,i,r,u){try{GetNexSequence("PAYMENT",function(u){var f=new PagoEncabezado,e;f.pagoDetalle=[];e=new PagoDetalle;f.paymentNum=parseInt(u);f.clientId=n.clientId;f.clientName=n.clientName;f.totalAmount=t.totalAmount;f.postedDatetime=t.postedDatetime;f.posTerminal=t.posTerminal;f.gps=t.gpsUrl;f.docDate=t.postedDatetime;f.depositToDate=null;f.isPosted=0;f.status="OPEN";f.paymentBoNum=null;e.id=f.paymentNum;e.paymentNum=null;e.paymentType=i.toString();e.lineNum=1;e.docDate=null;e.docNum=null;e.image=null;e.bankId=null;e.accountNum=null;e.invoiceNum=null;e.invoiceSerie=null;e.amountPaid=f.totalAmount;f.pagoDetalle.push(e);r(f)},function(n){notify("Error al obtener sequencia de documento: "+n.message)})}catch(f){u({codigo:-1,mensaje:"Error al generar el pago:"+f.message})}},n.prototype.formarPagoUnicoDesdeLista=function(n,t,i,r,u,f,e,o){try{this.obtenerSecuenciaDeDocumentos(function(t,o,s){var h=new PagoEncabezado,c;h.pagoDetalle=[];c=new PagoDetalle;h.paymentNum=parseInt(t);h.clientId=n.clientId;h.clientName=n.clientName;h.totalAmount=n.totalAmout;h.postedDatetime=getDateTime();h.posTerminal=gCurrentRoute;h.gps=gCurrentGPS;h.docDate=getDateTime();h.depositToDate=null;h.isPosted=0;h.status="OPEN";h.paymentBoNum=null;h.docSerie=o;h.docNum=s;c.id=h.paymentNum;c.paymentNum=h.paymentNum;c.paymentType=i.toString();c.lineNum=1;c.docDate=null;c.docNum=null;c.image=null;c.bankId=null;c.accountNum=null;c.invoiceNum=null;c.invoiceSerie=null;c.amountPaid=h.totalAmount;c.sourceDocType=TipoTarea.Preventa.toString();c.documentNumber=r;c.image1=u;c.image2=f;h.pagoDetalle.push(c);e(h)})}catch(s){o({codigo:-1,mensaje:"Error al generar el pago:"+s.message})}},n.prototype.obtenerFormatoDeImpresionDePago=function(n,t,i,r,u){try{this.ordenDeVentaServicio.obtenerCantidadDeSkuPorOrdenDeVenta(t,function(u){var b=localStorage.getItem("NAME_ENTERPRISE"),o="",s="",e="",l=0,y,p,f,w;l=380;l+=i.pagoDetalle.length===1?i.pagoDetalle.length*200:i.pagoDetalle.length*150;o="! 0 50 50 "+l+" 1\r\n";o+="! U1 LMARGIN 10\r\n! U\r\n! U1 PAGE-WIDTH 1400\r\nON-FEED IGNORE\r\n";o+="CENTER 550 T 1 2 0 10 "+b+"\r\n";o+="L 5  50 570 50 1\r\n";o+=n.clientName.length<21?"CENTER 550 T 1 2 0 60  "+n.clientName+"\r\n":"CENTER 550 T 0 2 0 60  "+n.clientName+"\r\n";o+="CENTER 550 T 0 2 0 100 "+n.address+"\r\n";y=t.docSerie;p=t.docNum;o+="CENTER 550 T 0 3 0 130 Recibo de Pago \r\n";o+="CENTER 550 T 0 3 0 160 Orden de Venta Serie "+y+"\r\n";o+="CENTER 550 T 0 3 0 190 No."+p+"\r\n";o+="CENTER 550 T 0 3 0 220 ***** ORIGINAL ***** \r\n";f=250;s="";for(var c=0,h=new PagoDetalle,a="",v=0,c=0;c<i.pagoDetalle.length;c++){h=i.pagoDetalle[c];switch(h.paymentType){case TipoDePago.Efectivo.toString():a="Efectico";break;case TipoDePago.Cheque.toString():a="Cheque"}s=s+"LEFT 5 T 0 2 0 "+f+" Forma de Pago: "+a+(h.paymentType!==TipoDePago.Efectivo.toString()?" No. de Doc: "+h.documentNumber+"\r\n":"\r\n");s=s+"RIGHT 550 T 0 2 0 "+f+" Q"+format_number(h.amountPaid,2)+"\r\n";f+=30;v+=h.amountPaid}f+=30;s+="L 5  "+f+" 570 "+f+" 1\r\n";f+=30;e+="LEFT 5 T 0 2 0 "+f+" Cantidad de SKU:\r\n";e+="RIGHT 550 T 0 2 0 "+f+" "+u+"\r\n";f+=30;s+="L 5  "+f+" 570 "+f+" 1\r\n";f+=30;e+="LEFT 5 T 0 2 0 "+f+" SUBTOTAL: \r\n";e+="RIGHT 550 T 0 2 0 "+f+" Q"+format_number(t.totalAmount,2)+"\r\n";i.totalAmount-v>0&&(f+=30,e+="LEFT 5 T 0 2 0 "+f+" AJUSTE: \r\n",e+="RIGHT 550 T 0 2 0 "+f+" Q"+format_number(i.totalAmount-v,2)+"\r\n");f+=30;e+="LEFT 5 T 0 2 0 "+f+" TOTAL:\r\n";e+="RIGHT 550 T 0 2 0 "+f+" Q"+format_number(i.totalAmount,2)+"\r\n";f+=30;e+="CENTER 550 T 0 2 0 "+f+" "+getDateTime()+" / RUTA "+gCurrentRoute+" \r\n";f+=30;e+="L 5  120 570 120 1\r\n";e+="PRINT\r\n";w=o+s+e;r(w)})}catch(f){u({codigo:-1,mensaje:"Error al obtener formato de impresion de pago de la orden de venta: "+f.message})}},n.prototype.guardarPago=function(n,t,i,r){var u=this;try{t?SONDA_DB_Session.transaction(function(t){var f=u.obtnerFormatoSqlDeInsertarParaPagoEncabezado(n),r;for(t.executeSql(f),r=0;r<n.pagoDetalle.length;r++)f=u.obtnerFormatoSqlDeInsertarParaPagoDetalle(n.pagoDetalle[r]),t.executeSql(f);i(n)},function(n){r({codigo:-1,mensaje:"2:Error al guardar el pago: "+n.message})}):i(n)}catch(f){r({codigo:-1,mensaje:"1:Error al guardar el pago: "+f.message})}},n.prototype.obtnerFormatoSqlDeInsertarParaPagoEncabezado=function(n){var t="";return t+="\tINSERT INTO PAYMENT_HEADER (",t+="PAYMENT_NUM, ",t+="CLIENT_ID, ",t+="CLIENT_NAME,",t+="TOTAL_AMOUNT, ",t+="POSTED_DATETIME, ",t+="POS_TERMINAL, ",t+="GPS, ",t+="DOC_DATE, ",t+="DEPOSIT_TO_DATE, ",t+="IS_POSTED, ",t+="STATUS,",t+="DOC_SERIE, ",t+="DOC_NUM",t+=")VALUES(",t+=""+n.paymentNum+",",t+="'"+n.clientId+"',",t+="'"+n.clientName+"',",t+=""+n.totalAmount+",",t+="'"+n.postedDatetime+"',",t+="'"+n.posTerminal+"',",t+="'"+n.gps+"',",t+="'"+n.docDate+"',",t+="'"+n.depositToDate+"',",t+=n.isPosted+",",t+="'"+n.status+"',",t+="'"+n.docSerie+"',",t+=n.docNum,t+");"},n.prototype.obtnerFormatoSqlDeInsertarParaPagoDetalle=function(n){var t="";return t+="INSERT INTO PAYMENT_DETAIL(",t+="ID,",t+=" PAYMENT_NUM,",t+=" PAYMENT_TYPE,",t+=" LINE_NUM,",t+=" DOC_DATE,",t+=" DOC_NUM,",t+=" IMAGE,",t+=" BANK_ID,",t+=" ACCOUNT_NUM,",t+=" INVOICE_NUM,",t+=" INVOICE_SERIE,",t+=" AMOUNT_PAID,",t+=" DOCUMENT_NUMBER,",t+=" SOURCE_DOC_TYPE,",t+=" SOURCE_DOC_SERIE,",t+=" SOURCE_DOC_NUM,",t+=" IMAGE_1,",t+=" IMAGE_2",t+=") VALUES (",t+=""+n.id+",",t+=" "+n.paymentNum+",",t+=" '"+n.paymentType+"',",t+=" "+n.lineNum+",",t+=" '"+n.docDate+"',",t+=" "+n.docNum+",",t+=" "+n.image+",",t+=" '"+n.bankId+"',",t+=" '"+n.accountNum+"',",t+=" "+n.invoiceNum+",",t+=" '"+n.invoiceSerie+"',",t+=" "+n.amountPaid+",",t+=" '"+n.documentNumber+"',",t+=" '"+n.sourceDocType+"',",t+=" '"+n.sourceDocSerie+"',",t+=" "+n.sourceDocNum+",",t+=n.image1!==undefined?" '"+n.image1+"',":"NULL,",t+=n.image2!==undefined?" '"+n.image2+"'":"NULL",t+")"},n.prototype.obtenerSecuenciaDeDocumentos=function(n){try{GetNexSequence(TIpoDeDocumento.Pago.toString(),function(t){ObtenerSecuenciaSiguiente(TIpoDeDocumento.Pago.toString(),function(i,r){n(t,i,r)},function(n){notify("3:Error al obtener sequencia de documento de pago: "+n.message)})},function(n){notify("2:Error al obtener sequencia de documento de pago: "+n.message)})}catch(t){notify("1:Error al obtener secuencia de documento: de pago"+t.message)}},n.prototype.obtenerTipoDePagoPorDocumentoDeOrdenDeVenta=function(n,t,i){try{SONDA_DB_Session.transaction(function(i){var r="SELECT";r+=" PAYMENT_TYPE";r+=" FROM PAYMENT_DETAIL";r+=" WHERE SOURCE_DOC_SERIE = '"+n.docSerie+"'";r+=" AND SOURCE_DOC_NUM = "+n.docNum;r+=" LIMIT 1";i.executeSql(r,[],function(n,i){if(i.rows.length>=1){var r=i.rows.item(0);t(r.PAYMENT_TYPE)}else t("Sin Pago")})},function(n){i({codigo:-1,mensaje:"Error al actualizar el documento de impreso: "+n.message})})}catch(r){i({codigo:-1,mensaje:"Error al obtener el tipo de pago: "+r.message})}},n}();